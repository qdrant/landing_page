{{ $currentNode := .context }}

<div class="docs-menu">
  <div id="sidebar" class="docs-menu__content">
    <nav>
      <div class="docs-menu__links-group">
        {{ $subject := site.GetPage "course" }}

        <p class="docs-menu__links-title">
          {{ $subject.Params.content.sidebarTitle }}
        </p>

        {{ if or (eq $currentNode.Params.isLesson true) (eq $currentNode.Parent.Params.isLesson true) }}
          {{ $allLessons := where $subject.Pages ".Params.isLesson" true }}
          {{ $total := len $allLessons }}

          {{ $currentIndex := 0 }}
          {{ range $i, $p := $allLessons }}
            {{ if eq $currentNode.Params.isLesson true }}
              {{ if eq $p.Permalink $currentNode.Permalink }}
                {{ $currentIndex = add $i 1 }}
              {{ end }}
            {{ else }}
              {{ if eq $p.Permalink $currentNode.Parent.Permalink }}
                {{ $currentIndex = add $i 1 }}
              {{ end }}
            {{ end }}
          {{ end }}

          {{ $percent := mul (div (float $currentIndex) (float $total)) 100 }}
          {{ $percentStr := printf "%.0f" $percent }}

          <div class="docs-menu__progress">
            <div class="docs-menu__progress-container">
              <div class="docs-menu__progress-bar" style="width: {{ $percentStr }}%;"></div>
            </div>
            <p class="docs-menu__progress-text">{{ $percentStr }}%</p>
          </div>
        {{ end }}

        <div
          class="
            mt-3
            docs-menu__articles-link
            docs-menu__links-group-heading{{ if eq $currentNode.RelPermalink "/course/" }} active{{ end }}
          "
        >
          <a href="{{ $subject.Params.content.menuTitle.url }}">
            {{ $subject.Params.content.menuTitle.text }}
          </a>
        </div>
        {{ range $subject.Pages }}
          {{ if .IsSection }}
            {{ $isActive := false }}
            {{ range .RegularPages }}
              {{ if eq .File.UniqueID $currentNode.File.UniqueID }}
                {{ $isActive = true }}
              {{ end }}
            {{ end }}

            {{ if eq .File.UniqueID $currentNode.File.UniqueID }}
              {{ $isActive = true }}
            {{ end }}

            {{ $sectionLink := .Permalink }}

            {{ if .Params.is_empty }}
              {{ $sectionLink = (index (.RegularPages) 0).Permalink }}
            {{ end }}

            <details
              class="docs-menu__links-group link-group {{ if eq .File.UniqueID $currentNode.File.UniqueID }}active{{ end }}"
              {{ if $isActive }}open{{ end }}
            >
              <summary class="docs-menu__links-group-heading">
                <a href="{{ $sectionLink }}">{{ .Title }}</a>
              </summary>
              <nav>
                <ul class="docs-menu__links-submenu">
                  {{ range .RegularPages }}
                    <div
                      class="docs-menu__links-group {{ if eq .File.UniqueID $currentNode.File.UniqueID }}active{{ end }}"
                    >
                      <div class="docs-menu__links-group-heading">
                        <a href="{{ .Permalink }}">{{ .Title }}</a>
                      </div>
                    </div>
                  {{ end }}
                </ul>
              </nav>
            </details>
          {{ else }}
            <div
              class="docs-menu__links-group {{ if eq .File.UniqueID $currentNode.File.UniqueID }}active{{ end }}"
            >
              <div class="docs-menu__links-group-heading">
                <a href="{{ .Params.url }}">{{ .Title }}</a>
              </div>
            </div>
          {{ end }}
        {{ end }}
      </div>
    </nav>
  </div>
</div>
